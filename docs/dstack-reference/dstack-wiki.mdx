# dstack Documentation

## 1. Introduction to dstack

dstack is a developer-friendly platform designed to simplify the deployment of containerized applications into Trusted Execution Environments (TEEs), specifically Intel TDX-based TEEs. It provides a secure framework for running confidential workloads with minimal configuration while maintaining robust security guarantees.

**Key Features:**

| Feature                              | Details                                                                 |
|--------------------------------------|-------------------------------------------------------------------------|
| Secure deployment                    | In Intel TDX-based TEEs                                                 |
| Developer experience                 | Uses standard docker-compose.yaml files                                 |
| Secure key management and secret handling | Includes encryption/decryption within Confidential VMs                  |
| Built-in TLS termination             | For service exposure, with option for TLS passthrough mode              |
| Remote attestation                   | Verifies integrity of Confidential Virtual Machines (CVMs)              |

## 2. Core Components

dstack comprises several core components that collaborate to manage and secure applications within TEEs, ensuring seamless deployment and robust security.

| Component          | Role                                                                 |
|--------------------|----------------------------------------------------------------------|
| dstack-vmm         | Manages Confidential Virtual Machines (CVMs) using Intel TDX, handles application lifecycle (deploy, start, stop, upgrade), allocates resources (CID pool, ports), communicates with KMS for key management and authorization, provides web interface for management. |
| dstack-gateway     | Acts as secure proxy for TLS termination, routes traffic to CVMs based on domain/request, manages certificates via Let's Encrypt ACME, sets up WireGuard VPN, monitors Certificate Transparency logs. Supports routing: `[s].` (port 80/443), `-[s].` (specified port), custom domains via DNS TXT records (`_dstack-app-address.`). |
| dstack-kms         | Generates/manages cryptographic keys (CA certificates, ECDSA, temporary CAs), authenticates via smart contracts (KmsAuth/AppAuth), provides RA-TLS attestation, authorizes execution based on attestation, manages onboarding. RPC endpoints: `get_temp_ca_cert`, `get_app_key`. |
| tdxctl             | Handles Full Disk Encryption (FDE) with LUKS, extends RTMRs for boot measurements, manages keys for encryption/authentication, bootstraps/updates rootfs, sets up WireGuard. Commands: `SetupFde`, `Tboot`. |

### 2.1 dstack-vmm

The dstack-vmm is the backbone of dstack, managing the lifecycle of Confidential Virtual Machines (CVMs) in Intel TDX environments. It orchestrates the creation, startup, shutdown, and removal of CVMs, ensuring secure deployment of containerized applications.

**Functions:**
- Manages CVM lifecycle (create, start, stop, remove) via App Logic and Supervisor integration.
- Allocates resources like CPU, memory, disk, CID, ports, and GPUs.
- Provides a web interface and API endpoints for deployment, monitoring, and management.

**Key Features:**
- **Architecture:** Includes Main Service (RpcHandler), App Logic, Supervisor Integration, and Configuration System.
- **API Endpoints:** Offers RPC API (/prpc), Host API (/api), Guest API (/guest), and Web Interface (/).
- **Networking:** Supports User Mode (default, QEMU with port forwarding) and Custom networking topologies with configurable DHCP and port mapping.
- **Security:** Integrates with [dstack-kms](#2.3-dstack-kms) for key management and [dstack-gateway](#2.2-dstack-gateway) for secure routing.
- **GPU Passthrough:** Manages GPU resources with device discovery and NUMA pinning.
- **Configuration:** Customizable via TOML files for VM resources, networking, and authentication.

**Example Deployment:**
Access the web interface at `http://localhost:9080`, upload a `docker-compose.yaml`, configure resources, and deploy.

### 2.2 dstack-gateway

The dstack-gateway acts as a secure reverse proxy, handling TLS termination and routing traffic to CVMs, ensuring secure and efficient communication.

**Functions:**
- Routes incoming HTTPS requests to appropriate CVMs based on domain or request.
- Automatically provisions and renews TLS certificates using Let's Encrypt.
- Sets up WireGuard VPN for secure tunnels to CVMs.

**Key Features:**
- **Certificate Management:** Automatic issuance and renewal via Let's Encrypt with DNS-01 challenges.
- **Domain-Based Routing:** Supports custom domains via DNS TXT records (e.g., `_dstack-app-address.myapp.example.com`).
- **Security:** Integrates with remote attestation and monitors Certificate Transparency logs.
- **High Availability:** Synchronizes state across multiple gateway instances for failover.

**Configuration Parameters:**

| Parameter       | Description                          | Example                              |
|-----------------|--------------------------------------|--------------------------------------|
| `SRV_DOMAIN`    | Base domain for services             | `app.example.com`                    |
| `PUBLIC_IP`     | Public IP address                    | `203.0.113.10`                       |
| `WG_ENDPOINT`   | WireGuard endpoint address           | `203.0.113.10:51820`                 |
| `GATEWAY_APP_ID`| Application ID for gateway           | `31884c4b7775affe4c99735f6c2aff7d7bc6cfcd` |

### 2.3 dstack-kms

The dstack-kms manages cryptographic keys and certificates, running within its own CVM to ensure secure key handling and remote attestation.

**Functions:**
- Generates and manages keys for disk encryption, environment variables, and application signing.
- Performs remote attestation to verify TEE authenticity.
- Interfaces with blockchain smart contracts for authorization.

**Key Features:**
- **Key Hierarchy:** Includes Root CA, ECDSA keys, and temporary CA certificates for initial authentication.
- **RPC Service:** Offers endpoints like `GetAppKey`, `GetTempCaCert`, and `SignCert`.
- **Onboarding Service:** Handles initialization via bootstrapping or onboarding from existing KMS.
- **Authorization:** Uses `KmsAuth` and `AppAuth` smart contracts for secure execution.

**Configuration:**
- Configured via TOML with sections for general settings, RPC server, core KMS settings, and authorization API.

### 2.4 tdxctl

The tdxctl is a command-line utility for managing Full Disk Encryption (FDE) and secure booting in dstack applications.

**Functions:**
- Sets up FDE using LUKS with application-specific keys.
- Manages secure boot processes, including key management and system state logging via RTMRs.

**Key Features:**
- **Commands:** Includes `SetupFde` for encryption setup and `Tboot` for secure booting.
- **Integration:** Works with [dstack-kms](#2.3-dstack-kms) for key retrieval and [dstack-gateway](#2.2-dstack-gateway) for registration.
- **Security:** Extends TDX RTMRs for cryptographic logging of system state.

**Example Command:**
```bash
tdxctl SetupFde --host-shared --work-dir --rootfs-dir --root-hd --root-cdrom --root-cdrom-mnt --rootfs-integrity --rootfs-hash
```

## 3. Security Architecture

dstack's security architecture leverages Intel TDX to protect applications within TEEs, addressing threats like unauthorized code execution and data exfiltration through hardware-based trust, remote attestation, and blockchain-based authorization.

**Key Security Features:**
- **Remote Attestation:** Verifies CVM integrity using TDX Attestation Quotes.
- **Key Management Service (KMS):** Manages keys and certificates with secure derivation and storage.
- **Blockchain Authorization:** Uses smart contracts to control access and validate measurements.

**Architecture Diagram:**
```
[Application] --> [dstack-gateway] --> [CVM]
                                    |
                                    v
                               [dstack-vmm]
                                    |
                                    v
                               [dstack-kms] <--> [Blockchain]
```

### 3.1 Remote Attestation

Remote attestation ensures CVMs are genuine and untampered, providing cryptographic proof of their state.

**Process:**
1. **Quote Generation:** Created within the TDX environment.
2. **Quote Verification:** Checked using Intel DCAP.
3. **Event Log Analysis:** Verifies system events like app-id and compose-hash.
4. **Application Information Extraction:** Retrieves app-specific data.
5. **Blockchain Verification:** Confirms measurements against blockchain records.
6. **Key Provisioning:** Provides keys upon successful verification.

**Key Features:**
- Uses RA-TLS certificates with custom extensions for TDX quotes and event logs.
- Validates TCB to ensure debug mode is disabled.

### 3.2 Certificate Management

Certificate management automates TLS certificate handling for secure communications, primarily for the [dstack-gateway](#2.2-dstack-gateway).

**Components:**
- **Certbot:** Manages certificate issuance and renewal via Let's Encrypt.
- **CT Monitor:** Monitors Certificate Transparency logs for unauthorized certificates.

**Features:**
- Automatic issuance and renewal using DNS-01 challenges.
- Supports custom domains and CAA records for restricted CA issuance.
- Integrates with remote attestation for enhanced security.

**CLI Commands:**
| Command        | Description                          |
|----------------|--------------------------------------|
| `certbot renew`| Check/renew certificates if needed   |
| `certbot init` | Initialize new ACME account          |
| `certbot set-caa`| Set CAA records                     |

### 3.3 Authorization System

The authorization system uses blockchain smart contracts to manage access control for applications and KMS instances.

**Components:**
- **KmsAuth Contract:** Validates KMS instances and manages application registration.
- **AppAuth Contract:** Controls authorization for individual applications.

**Process:**
- Applications submit boot information (e.g., appId, composeHash) to KmsAuth.
- KmsAuth verifies registration and delegates to AppAuth for compose hash and device checks.
- Access is granted based on blockchain-stored measurements and device IDs.

**Key Data Structures:**
| Data Structure | Description                                                                 |
|----------------|-----------------------------------------------------------------------------|
| AppBootInfo    | Contains boot information: appId, composeHash, instanceId, deviceId         |
| KmsInfo        | Contains KMS information: k256Pubkey, caPubkey, quote, eventlog            |

## 4. SDK and Client Libraries

dstack provides SDKs for Go, JavaScript, and Python to facilitate integration with its services, enabling developers to interact with TEEs and manage cryptographic operations.

**Available SDKs:**

| Language | SDK Name | Client Types | Installation | Key Methods | Blockchain Integration | Purpose |
|----------|----------|--------------|--------------|-------------|-----------------------|---------|
| Go       | Go SDK   | DstackClient, TappdClient (legacy) | `go get github.com/Dstack-TEE/dstack/sdk/go` | `GetKey`, `GetQuote`, `Info`, `GetTlsKey` | None | Comprehensive support for dstack features in Go applications |
| JavaScript | JavaScript SDK | DstackClient | `npm install @phala/dstack-sdk` | `getKey`, `getQuote`, `info`, `getTlsKey` | Ethereum (via viem/web3), Solana (via solders/@solana/web3.js) | For Node.js and browser applications with optional blockchain integration |
| Python   | Python SDK | DstackClient (sync), AsyncDstackClient (async) | `pip install dstack-sdk` | `get_key`, `get_quote`, `info`, `get_tls_key` | Ethereum (via web3.py), Solana | Synchronous and asynchronous clients with optional blockchain integration |

### 4.1 Go SDK

The Go SDK enables Go applications to interact with dstack services, providing key derivation, TDX quote generation, and system information retrieval.

**Features:**
- **Clients:** DstackClient (primary) and TappdClient (legacy).
- **Key Methods:** `GetKey`, `GetTlsKey`, `GetQuote`, `Info`.
- **Installation:** `go get github.com/Dstack-TEE/dstack/sdk/go`.

**Usage Example:**
```go
client, err := dstack.NewDstackClient(dstack.WithEndpoint("http://custom-endpoint"))
if err != nil {
    log.Fatal(err)
}
info, err := client.Info()
```

### 4.2 JavaScript SDK

The JavaScript SDK supports Node.js and browser applications, with optional blockchain integrations for Ethereum and Solana.

**Features:**
- **Client:** DstackClient for interacting with the guest agent.
- **Key Methods:** `getKey`, `getQuote`, `info`, `getTlsKey`.
- **Installation:** `npm install @phala/dstack-sdk`.

**Usage Example:**
```javascript
const { DstackClient } = require('@phala/dstack-sdk');
const client = new DstackClient();
client.info().then(info => console.log(info));
```

### 4.3 Python SDK

The Python SDK offers synchronous and asynchronous clients for interacting with dstack services, supporting blockchain integrations.

**Features:**
- **Clients:** DstackClient (sync) and AsyncDstackClient (async).
- **Key Methods:** `get_key`, `get_quote`, `info`, `get_tls_key`.
- **Installation:** `pip install dstack-sdk`.

**Usage Example:**
```python
from dstack_sdk import DstackClient
client = DstackClient()
info = client.info()
print(info)
```

## 5. Development and Integration

dstack supports development and integration through a custom RPC system and a guest agent, enabling secure communication and application management within CVMs.

**Key Components:**
- **RPC System:** Uses Protocol Buffers and RA-TLS for secure communication.
- **Guest Agent:** Provides cryptographic services and system information within CVMs.

### 5.1 RPC System

The RPC system facilitates secure communication between dstack components using RA-TLS and Protocol Buffers.

**Architecture:**
- Built on the `ra-rpc` crate with Rocket integration.
- Uses `RpcCall` trait for request handling and `prpc_routes!` macros for service definition.

**Request Handling:**
- Parses requests, validates attestation, and dispatches to services.
- Supports JSON and binary payloads with size limits for security.

### 5.2 Guest Agent

The guest agent runs inside each CVM, providing essential services to applications.

**Functions:**
- Manages TLS keys and certificates.
- Derives cryptographic keys (ECDSA).
- Generates TDX quotes for attestation.
- Provides CVM and application information.

**Service Interfaces:**
- **DstackGuest Service:** Primary interface with methods like `GetTlsKey` and `GetQuote`.
- **Tappd Service:** Legacy interface for backward compatibility.
- **Worker Service:** External interface for system information.

## 6. Deployment Guide

The deployment guide outlines the steps to set up dstack components and deploy applications on TEE-enabled servers.

**Key Steps:**

| Step                     | Description                                                                 |
|--------------------------|-----------------------------------------------------------------------------|
| Set Up dstack-vmm        | Configure and run the Virtual Machine Manager.                              |
| Deploy KmsAuth Contract  | Set up authentication contract on an Ethereum-compatible blockchain.        |
| Deploy KMS Into CVM      | Configure and deploy the Key Management Service with remote attestation.    |
| Add Base Image MRs       | Whitelist system measurements for KMS.                                      |
| Deploy dstack-gateway     | Set up the gateway for TLS termination and traffic routing.                 |
| Deploy Applications      | Register and deploy applications via the web interface.                     |
| Application Access       | Configure domain access through the gateway.                                |
| Certificate Management   | Automate certificate handling with Let's Encrypt.                           |
| Monitoring/Management    | Use APIs for logging and application management.                            |
| Troubleshooting          | Address issues like CID conflicts and user namespace errors.                |

**Example Deployment:**
```bash
# Deploy KMS
./kms/dstack-app/deploy-to-vmm.sh
# Deploy Gateway
./gateway/dstack-app/deploy-to-vmm.sh
# Deploy Application
dstack deploy -f docker-compose.yml
```

**Key Citations:**
- [dstack Introduction Overview](https://deepwiki.com/Dstack-TEE/dstack/1-introduction-to-dstack)
- [dstack Core Components](https://deepwiki.com/Dstack-TEE/dstack/2-core-components)
- [dstack-vmm Documentation](https://deepwiki.com/Dstack-TEE/dstack/2.1-dstack-vmm)
- [dstack-gateway Documentation](https://deepwiki.com/Dstack-TEE/dstack/2.2-dstack-gateway)
- [dstack-kms Documentation](https://deepwiki.com/Dstack-TEE/dstack/2.3-dstack-kms)
- [tdxctl Documentation](https://deepwiki.com/Dstack-TEE/dstack/2.4-tdxctl)
- [dstack Security Architecture](https://deepwiki.com/Dstack-TEE/dstack/3-security-architecture)
- [dstack Remote Attestation](https://deepwiki.com/Dstack-TEE/dstack/3.1-remote-attestation)
- [dstack Certificate Management](https://deepwiki.com/Dstack-TEE/dstack/3.2-certificate-management)
- [dstack Authorization System](https://deepwiki.com/Dstack-TEE/dstack/3.3-authorization-system)
- [dstack SDK and Client Libraries](https://deepwiki.com/Dstack-TEE/dstack/4-sdk-and-client-libraries)
- [dstack Go SDK Documentation](https://deepwiki.com/Dstack-TEE/dstack/4.1-go-sdk)
- [dstack JavaScript SDK Documentation](https://deepwiki.com/Dstack-TEE/dstack/4.2-javascript-sdk)
- [dstack Python SDK Documentation](https://deepwiki.com/Dstack-TEE/dstack/4.3-python-sdk)
- [dstack Development and Integration](https://deepwiki.com/Dstack-TEE/dstack/5-development-and-integration)
- [dstack RPC System Documentation](https://deepwiki.com/Dstack-TEE/dstack/5.1-rpc-system)
- [dstack Guest Agent Documentation](https://deepwiki.com/Dstack-TEE/dstack/5.2-guest-agent)
- [dstack Deployment Guide](https://deepwiki.com/Dstack-TEE/dstack/6-deployment-guide)