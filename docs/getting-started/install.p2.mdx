
## Step 1: Install System Dependencies

First, update your system and install required packages:

```bash
# Update package lists
sudo apt update && sudo apt upgrade -y

# Install build dependencies
sudo apt-get install -y \
    build-essential \
    chrpath \
    diffstat \
    lz4 \
    wireguard-tools \
    xorriso \
    git \
    curl \
    wget

# Install additional tools
sudo apt-get install -y \
    jq \
    htop \
    net-tools \
    ca-certificates
```

### Install Rust

dstack is built with Rust. Install it using rustup:

```bash
# Download and install rustup
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# Follow the prompts and select default installation

# Source cargo environment
source $HOME/.cargo/env

# Verify installation
rustc --version
```

Expected output:
```
rustc 1.75.0 (or newer)
```

## Step 2: Clone and Build dstack

### Clone the Repository

```bash
# Create workspace directory
mkdir -p ~/dstack-workspace
cd ~/dstack-workspace

# Clone with submodules
git clone https://github.com/Dstack-TEE/meta-dstack.git --recursive
cd meta-dstack
```

### Configure Build Settings

```bash
# Generate default configuration
./build.sh hostcfg

# This creates build-config.sh
```

<details>
<summary>Advanced: Customize build configuration</summary>

Edit `build-config.sh` to customize settings:

```bash
# Network configuration
KVM_TAP_NETWORK="10.8.8.0/24"
GATEWAY_WG_NETWORK="10.9.0.0/16"

# Resource allocation
CID_START=33000
CID_POOL_SIZE=1000

# Performance tuning
MAX_VMS=50
DEFAULT_VM_MEMORY=4096
```

After editing, regenerate configuration:
```bash
./build.sh hostcfg
```

</details>

### Build dstack Components

```bash
# Build all components
./build.sh build

# This compiles:
# - dstack-vmm (Virtual Machine Manager)
# - dstack-gateway (HTTPS Gateway)
# - dstack-kms (Key Management Service)
# - Supporting tools
```

Build time: ~10-15 minutes on modern hardware

## Step 3: Download or Build Guest OS Image

dstack applications run inside a secure guest OS. You can either download a pre-built image or build your own.

### Option A: Download Pre-built Image (Recommended)

```bash
# Download latest stable version
./build.sh dl 0.5.1

# Verify download
ls -lah dstack-guest-*.img
```

### Option B: Build Guest Image

<details>
<summary>Build from source (advanced)</summary>

```bash
# Ensure AppArmor allows unprivileged namespaces
sudo sysctl kernel.apparmor_restrict_unprivileged_userns=0

# Build guest image
./build.sh guest

# This builds a minimal Linux image with:
# - dstack-os (secure OS)
# - dstack-guest-agent
# - Container runtime
```

Build time: ~30-45 minutes

</details>

## Step 4: Configure dstack Components

### Create Configuration Files

Create the necessary configuration directory and files for dstack components:

```bash
# Create config directory
mkdir -p ~/.dstack/config
cd ~/.dstack/config
```

Each dstack component requires specific configuration. The following sections provide the essential configuration files:

<details>
<summary>KMS Configuration (kms.toml)</summary>

The Key Management Service handles cryptographic operations and blockchain integration:

```toml
[general]
name = "dstack-kms-01"
log_level = "info"

[rpc]
listen = "127.0.0.1:8000"
ra_tls_cert = "/etc/dstack/certs/kms.crt"
ra_tls_key = "/etc/dstack/certs/kms.key"

[core]
blockchain_rpc = "https://ethereum-rpc.example.com"
contract_address = "0x..."  # Will be set during deployment

[authorization]
api_endpoint = "http://localhost:9080/api"
```

Key configuration notes:
- `listen`: Local interface binding for security
- `ra_tls_cert/key`: Remote attestation TLS certificates  
- `blockchain_rpc`: Ethereum RPC endpoint for smart contract interaction
- `contract_address`: Set automatically during first deployment

</details>

<details>
<summary>Gateway Configuration (gateway.toml)</summary>

The Gateway provides HTTPS ingress and manages external connectivity:

```toml
[general]
name = "dstack-gateway-01"
log_level = "info"

[network]
public_ip = "YOUR_PUBLIC_IP"
wg_endpoint = "YOUR_PUBLIC_IP:51820"
srv_domain = "app.yourdomain.com"

[gateway]
app_id = "auto-generated-on-first-run"
listen = "0.0.0.0:443"
http_listen = "0.0.0.0:80"

[certificate]
email = "admin@yourdomain.com"
use_staging = false  # Set to true for testing
```

Configuration requirements:
- `public_ip`: Replace with your server's actual public IP address
- `srv_domain`: Your domain for application access (configure DNS accordingly)
- `email`: Valid email for Let's Encrypt certificate generation
- `use_staging`: Use `true` for testing to avoid rate limits

</details>

<details>
<summary>VMM Configuration (vmm.toml)</summary>

The Virtual Machine Manager orchestrates Confidential VMs:

```toml
[general]
name = "dstack-vmm-01"
log_level = "info"

[resources]
cid_start = 33000
cid_pool_size = 1000
max_vms = 50

[network]
mode = "user"  # or "tap" for advanced networking
interface = "eth0"

[api]
listen = "127.0.0.1:9080"
public_url = "http://localhost:9080"
```

Resource allocation settings:
- `cid_start/cid_pool_size`: VSOCK CID allocation range
- `max_vms`: Maximum concurrent Confidential VMs
- `mode`: "user" for simple setup, "tap" for advanced networking
- `interface`: Primary network interface name

</details>

## Step 5: Initialize TLS Certificates

Generate initial certificates for secure inter-component communication:

<details>
<summary>Certificate Generation Commands</summary>

```bash
# Create certificate directory
sudo mkdir -p /etc/dstack/certs
cd /etc/dstack/certs

# Generate self-signed certificate for initial setup
sudo openssl req -x509 -newkey rsa:4096 \
    -keyout kms.key -out kms.crt \
    -days 365 -nodes \
    -subj "/CN=dstack-kms/O=dstack"

# Set proper permissions
sudo chmod 600 kms.key
sudo chmod 644 kms.crt
```

These certificates will be replaced with proper attestation-based certificates during the first service startup.

</details>

## Step 6: Start dstack Services

Launch dstack services in the correct dependency order. You can use either the terminal method for testing or systemd services for production:

### Terminal Method (Recommended for Initial Setup)

Start each component in a separate terminal for easier debugging:

<details>
<summary>Service Startup Commands</summary>

```bash
# Terminal 1: Start KMS
cd ~/dstack-workspace/meta-dstack
./dstack-kms -c ~/.dstack/config/kms.toml

# Terminal 2: Start Gateway (requires sudo for port binding)
cd ~/dstack-workspace/meta-dstack
sudo ./dstack-gateway -c ~/.dstack/config/gateway.toml

# Terminal 3: Start VMM
cd ~/dstack-workspace/meta-dstack
./dstack-vmm -c ~/.dstack/config/vmm.toml
```

Watch for successful startup messages:
- KMS: "Key Management Service started on 127.0.0.1:8000"
- Gateway: "Gateway listening on 0.0.0.0:443"  
- VMM: "Virtual Machine Manager API available on 127.0.0.1:9080"

</details>

### Systemd Services (Production Setup)

<details>
<summary>Systemd Service Configuration</summary>

For production deployments, configure systemd services for automatic startup and management:

Create service files for each component:

```bash
# Create KMS service file
sudo tee /etc/systemd/system/dstack-kms.service > /dev/null <<EOF
[Unit]
Description=dstack Key Management Service
After=network.target

[Service]
Type=simple
User=$USER
WorkingDirectory=$HOME/dstack-workspace/meta-dstack
ExecStart=$HOME/dstack-workspace/meta-dstack/dstack-kms -c $HOME/.dstack/config/kms.toml
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# Create Gateway service file
sudo tee /etc/systemd/system/dstack-gateway.service > /dev/null <<EOF
[Unit]
Description=dstack Gateway Service
After=network.target dstack-kms.service

[Service]
Type=simple
User=root
WorkingDirectory=$HOME/dstack-workspace/meta-dstack
ExecStart=$HOME/dstack-workspace/meta-dstack/dstack-gateway -c $HOME/.dstack/config/gateway.toml
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# Create VMM service file
sudo tee /etc/systemd/system/dstack-vmm.service > /dev/null <<EOF
[Unit]
Description=dstack Virtual Machine Manager
After=network.target dstack-kms.service

[Service]
Type=simple
User=$USER
WorkingDirectory=$HOME/dstack-workspace/meta-dstack
ExecStart=$HOME/dstack-workspace/meta-dstack/dstack-vmm -c $HOME/.dstack/config/vmm.toml
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# Enable and start all services
sudo systemctl daemon-reload
sudo systemctl enable dstack-kms dstack-gateway dstack-vmm
sudo systemctl start dstack-kms dstack-gateway dstack-vmm

# Verify services are running
sudo systemctl status dstack-kms dstack-gateway dstack-vmm
```

</details>

## Step 7: Verify Installation

### Check Service Status

```bash
# If using systemd
sudo systemctl status dstack-kms dstack-gateway dstack-vmm

# Check logs
sudo journalctl -u dstack-vmm -f
```

### Access Web UI

Open your browser and navigate to:
- **Local**: http://localhost:9080
- **Remote**: http://YOUR_SERVER_IP:9080

You should see the dstack management interface.

### Test API Endpoints

```bash
# Check VMM health
curl http://localhost:9080/api/health

# Expected response
{"status":"healthy","version":"0.5.1"}
```

## Troubleshooting

This section covers common issues encountered during dstack installation on Linux systems:

<details>
<summary>Services Fail to Start</summary>

**Problem**: dstack services won't start or crash immediately

**Diagnosis Steps**:
1. Check service logs for specific errors:
   ```bash
   sudo journalctl -u dstack-vmm -n 50
   sudo journalctl -u dstack-kms -n 50  
   sudo journalctl -u dstack-gateway -n 50
   ```

2. Verify required ports are available:
   ```bash
   sudo netstat -tulpn | grep -E '9080|9090|443|80|8000|51820'
   ```

3. Ensure configuration files are valid TOML:
   ```bash
   # Check for syntax errors
   cat ~/.dstack/config/*.toml | grep -E "^\[|="
   ```

4. Verify file permissions:
   ```bash
   ls -la ~/.dstack/config/
   ls -la /etc/dstack/certs/
   ```

**Common Solutions**:
- Release occupied ports: `sudo systemctl stop apache2 nginx` (if using port 80/443)
- Fix configuration syntax errors
- Ensure proper certificate permissions: `sudo chmod 600 /etc/dstack/certs/*.key`

</details>

<details>
<summary>Build Failures</summary>

**Problem**: Compilation fails during `./build.sh build`

**Diagnosis Steps**:
1. Verify all dependencies are installed:
   ```bash
   ./build.sh check-deps
   ```

2. Check Rust toolchain version:
   ```bash
   rustc --version  # Should be 1.75.0 or newer
   cargo --version
   ```

3. Inspect build logs for specific errors:
   ```bash
   ./build.sh build 2>&1 | tee build.log
   tail -50 build.log
   ```

**Common Solutions**:
- Update Rust toolchain: `rustup update`
- Clear build cache and retry: `./build.sh clean && ./build.sh build`
- Install missing system dependencies: `sudo apt update && sudo apt install -y build-essential`
- Check available disk space: `df -h`

</details>

<details>
<summary>TEE Hardware Issues</summary>

**Problem**: TDX not detected or attestation failures

**Diagnosis Steps**:
1. Verify CPU TDX support:
   ```bash
   grep -E 'tdx|TDX' /proc/cpuinfo
   lscpu | grep -i tdx
   ```

2. Check kernel TDX module status:
   ```bash
   sudo dmesg | grep -i tdx
   lsmod | grep tdx
   ```

3. Verify BIOS/UEFI settings:
   ```bash
   sudo dmesg | grep -E "TDX|Trust|Domain"
   ```

**Common Solutions**:
- Enable TDX in BIOS/UEFI settings
- Update to TDX-enabled kernel: `sudo apt update && sudo apt upgrade linux-*`
- Verify hardware compatibility with Intel documentation
- For testing without TDX hardware, use Phala Cloud

</details>

<details>
<summary>Network Connectivity Issues</summary>

**Problem**: Cannot access web UI or API endpoints

**Diagnosis Steps**:
1. Check firewall status and rules:
   ```bash
   sudo ufw status
   sudo iptables -L
   ```

2. Verify WireGuard installation:
   ```bash
   wg version
   sudo systemctl status wg-quick@*
   ```

3. Test local connectivity:
   ```bash
   nc -zv localhost 9080
   curl -I http://localhost:9080/api/health
   ```

4. Check network interface configuration:
   ```bash
   ip addr show
   ip route show
   ```

**Common Solutions**:
- Configure firewall to allow required ports: `sudo ufw allow 9080,443,80,51820`
- Restart networking: `sudo systemctl restart networking`
- Verify DNS resolution for domain configuration
- Check for conflicting network services

</details>

<details>
<summary>Guest Image Issues</summary>

**Problem**: Guest image download or build failures

**Diagnosis Steps**:
1. Check available disk space:
   ```bash
   df -h ~/dstack-workspace/
   ```

2. Verify download integrity:
   ```bash
   ls -la dstack-guest-*.img*
   sha256sum dstack-guest-*.img
   ```

3. Check build environment for guest compilation:
   ```bash
   sudo sysctl kernel.apparmor_restrict_unprivileged_userns
   ```

**Common Solutions**:
- Free up disk space (images are ~500MB)
- Re-download corrupted images: `./build.sh dl 0.5.1 --force`
- Configure AppArmor for builds: `sudo sysctl kernel.apparmor_restrict_unprivileged_userns=0`
- Use pre-built images instead of building from source

</details>

<details>
<summary>Performance Issues</summary>

**Problem**: Slow deployment or poor CVM performance

**Diagnosis Steps**:
1. Check system resource usage:
   ```bash
   htop
   iostat -x 1
   free -h
   ```

2. Monitor dstack service performance:
   ```bash
   sudo systemctl status dstack-*
   journalctl -u dstack-vmm --since "1 hour ago"
   ```

**Common Solutions**:
- Increase VM memory allocation in VMM configuration
- Use faster storage (NVMe SSD recommended)
- Adjust CPU allocation and enable CPU pinning
- Monitor and optimize container resource limits

</details>

## Next Steps

Congratulations! You've successfully installed dstack. Now you can:

<CardGroup cols={2}>
  <Card title="Deploy Your First App" icon="rocket" href="/docs/getting-started/first-deployment">
    Quick deployment guide
  </Card>
  {/* Monitoring guide coming soon:
  <Card title="Configure Monitoring" icon="chart-line" href="/deployment-guides/monitoring-and-logging">
    Set up monitoring and logging
  </Card>
  */}
  <Card title="Explore Examples" icon="code" href="/docs/tutorials/python-example">
    Browse code examples
  </Card>
</CardGroup>

## Additional Resources

- [System Architecture](/docs/concepts/architecture) - Understand how dstack components work together
- [Security Model](/docs/concepts/security-model) - Learn about TEE security features
- [Troubleshooting Guide](/docs/troubleshooting) - Detailed solutions for common issues
- [Community Support](https://github.com/Dstack-TEE/dstack/discussions) - Get help from the community
- [First Deployment Guide](/docs/getting-started/first-deployment) - Deploy your first application 