# dstack Documentation

## Overview

### What is dstack?

dstack is an open-source platform designed to simplify the deployment of secure applications to Trusted Execution Environments (TEEs), specifically using Confidential VMs (CVMs). It enables developers to deploy containerized applications with minimal code changes, leveraging familiar tools like Docker, while ensuring robust security through features like remote attestation, end-to-end encryption, and decentralized key management. By abstracting the complexities of TEEs, dstack makes secure computing accessible to a wide range of developers and enterprises.

### Key Features

* **Seamless TEE Deployment:** Converts any Docker container into a CVM image for secure execution within TEEs, requiring no significant changes to existing workflows.
* **Remote Attestation:** Provides APIs to verify the integrity and security of the execution environment, ensuring trust in the deployed application.
* **Encrypted Communication:** Automatically wraps communications with HTTPS and uses content addressing for secure input and output.
* **Decentralized Key Management:** Utilizes a blockchain-controlled Key Management Service (KMS) to manage encryption keys, ensuring portability and avoiding vendor lock-in.
* **Portable Workloads:** Enables applications to migrate across different TEE hardware, offering flexibility in deployment choices.

### Benefits

* **For Developers:** Deploy secure applications using standard development workflows, without needing extensive TEE expertise.
* **For Enterprises:** Ensure data privacy and integrity for sensitive workloads, with verifiable security measures that reduce operational risks.
* **Unique Advantages:** dstack’s hardware-agnostic architecture, decentralized governance via smart contracts, and Zero Trust TLS for secure access set it apart from traditional deployment platforms.

**See Also:** [System Architecture](#system-architecture), [Security Model](#security-model)

## Getting Started

### Prerequisites

To use dstack, ensure you have the following:

* **Hardware:** A TEE-capable server, such as one with Intel TDX, with at least 16GB RAM and 100GB disk space.
* **Operating System:** Ubuntu 24.04.
* **Software Dependencies:**
  * `build-essential`
  * `chrpath`
  * `diffstat`
  * `lz4`
  * `wireguard-tools`
  * `xorriso`
  * Rust (installed via [rustup](https://sh.rustup.rs))

### Installation

Follow these steps to set up dstack on your server:

1. **Install Dependencies:**

   ```bash
   sudo apt-get install build-essential chrpath diffstat lz4 wireguard-tools xorriso
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
   ```

2. **Clone the meta-dstack Repository:**

   ```bash
   git clone https://github.com/Dstack-TEE/meta-dstack.git --recursive
   ```

3. **Build Artifacts:**

   Navigate to the repository and build the necessary components:

   ```bash
   cd meta-dstack
   ../build.sh hostcfg
   ```

   Edit `build-config.sh` for custom configurations (e.g., network settings) and rerun `../build.sh hostcfg` if needed.

4. **Download or Build Guest Image:**

   * To download a pre-built guest image (version 0.5.1):

     ```bash
     ../build.sh dl 0.5.1
     ```

   * To build the guest image locally:

     ```bash
     ../build.sh guest
     ```

5. **Run dstack Components:**

   Start each component in a separate terminal:

   * **Key Management Service:**

     ```bash
     ./dstack-kms -c kms.toml
     ```

   * **Gateway:**

     ```bash
     sudo ./dstack-gateway -c gateway.toml
     ```

   * **Virtual Machine Manager:**

     ```bash
     ./dstack-vmm -c vmm.toml
     ```

**Note:** Ensure configuration files (`kms.toml`, `gateway.toml`, `vmm.toml`) are correctly set up. Example configurations are provided in [Configuring dstack Components](#configuring-dstack-components).

### First Deployment

1. **Prepare Your Application:**

   Containerize your application using a `Dockerfile` or `docker-compose.yml`. For example, a simple Python Flask application:

   ```dockerfile
   FROM python:3.9
   WORKDIR /app
   COPY . /app
   RUN pip install flask
   CMD ["python", "app.py"]
   ```

2. **Deploy Using dstack CLI:**

   ```bash
   dstack deploy -f docker-compose.yml
   ```

   This command creates a CVM, sets up the environment, and starts your application.

3. **Verify Deployment:**

   Access the web UI at `http://localhost:9080` to monitor your application’s status. Alternatively, use API calls to check deployment details.

### Verifying the Deployment

* **Web UI:** Navigate to `http://localhost:9080` to view application status and logs.
* **API Verification:** Use API endpoints to confirm the application is running (see [API Documentation](#api-documentation)).
* **Remote Attestation:** Verify the CVM’s integrity using the [TEE Attestation Explorer](https://ra-quote-explorer.vercel.app/).

**See Also:** [Deploying Applications](#deploying-applications), [Tutorials](#tutorials)

## Concepts

### System Architecture

dstack’s architecture is organized into layers to ensure secure, scalable, and portable application deployment:

1. **User Interface Layer:**
   * **dstack CLI:** Provides a command-line interface for deploying and managing applications.

2. **Orchestration Layer:**
   * **dstack-vmm:** Manages the creation and lifecycle of Confidential VMs (CVMs).
   * **dstack-gateway:** Routes incoming HTTPS requests to the appropriate CVM instances.

3. **CVM Layer:**
   * **dstack-os:** A minimized operating system running inside the CVM for a secure runtime.
   * **dstack-guest-agent:** Manages Docker containers within the CVM.
   * **User’s Docker Containers:** Execute application code in a secure environment.

4. **Security Layer:**
   * **dstack-kms:** Handles encryption keys via a decentralized Key Management Service.
   * **Remote Attestation:** Ensures environment integrity using components like `ra-rpc` and `ra-tls`.

5. **Decentralized Services:**
   * **Decentralized KMS:** Provides deterministic encryption keys.
   * **Blockchain/Smart Contracts:** Governs code deployment and upgrades transparently.

**Architecture Diagram:**

```
[User] --> [dstack CLI] --> [dstack-vmm] --> [CVM]
                                           |
                                           v
                                      [dstack-os]
                                           |
                                           v
                                 [dstack-guest-agent] --> [Docker Containers]
                                           |
                                           v
                                      [dstack-kms] <--> [Decentralized KMS]
```

### Core Components

| Component          | Role                                          | Dependencies                   |
| ------------------ | --------------------------------------------- | ------------------------------ |
| dstack CLI         | User interface for deployment and management  | dstack-vmm, dstack-gateway     |
| dstack-vmm         | Manages CVM lifecycle and setup               | dstack-os, dstack-guest-agent  |
| dstack-gateway     | Handles HTTPS traffic and routing             | dstack-vmm, certbot            |
| dstack-kms         | Manages encryption keys via decentralized KMS | Decentralized KMS              |
| dstack-guest-agent | Manages Docker containers inside CVM          | dstack-os, Docker containers   |
| dstack-os          | Provides minimized OS for CVM runtime         | TEE hardware (e.g., Intel TDX) |

### Security Model

dstack ensures robust security through:

* **Trusted Execution Environments (TEEs):** Hardware-based isolation for code and data.
* **Remote Attestation:** Verifies the CVM’s integrity and configuration using signed reports.
* **Decentralized Key Management:** Uses a blockchain-controlled KMS for secure, portable key management.
* **End-to-End Encryption:** Secures communication between components and external services.

### Networking

The `dstack-gateway` manages networking by handling HTTPS requests and routing them to CVMs. It supports Zero Trust TLS for secure, verifiable access, integrating with tools like Let’s Encrypt for certificate management.

**See Also:** [Managing Keys and Secrets](#managing-keys-and-secrets), [Monitoring and Logging](#monitoring-and-logging)

## Deployment Guides

### Deploying Applications

To deploy an application:

1. **Containerize Your Application:** Use a `Dockerfile` or `docker-compose.yml` to define your application.

   ```yaml
   version: '3.8'
   services:
     app:
       image: myapp-image
       ports:
         - "8080:8080"
   ```

2. **Deploy with dstack CLI:**

   ```bash
   dstack deploy -f docker-compose.yml
   ```

3. **Verify Deployment:** Check the web UI or API for status.

### Configuring dstack Components

Configure components using TOML files:

* **vmm.toml:**

  ```toml
  [general]
  cid_start = 33000
  cid_pool_size = 1000
  [network]
  interface = "eth0"
  ```

* **gateway.toml:** Configures HTTPS routing and certificates.

* **kms.toml:** Sets up key management parameters.

### Managing Keys and Secrets

* **Key Management:** Use `dstack-kms` to request keys from the decentralized KMS.
* **Secrets:** Pass secrets via environment variables or mounted volumes in `docker-compose.yml`:

  ```yaml
  services:
    app:
      image: myapp-image
      environment:
        - MY_SECRET=${MY_SECRET}
  ```

### Monitoring and Logging

* **Web UI:** Access `http://localhost:9080` for real-time monitoring.

* **API Logs:** Fetch logs using:

  ```bash
  curl 'http://<app-id>.app.kvin.wang:9090/logs/?since=0&until=0&follow=true&text=true&timestamps=true&bare=true'
  ```

* **Certificate Transparency:** Monitor HTTPS certificate issuance.

**See Also:** [Tutorials](#tutorials), [Troubleshooting](#troubleshooting)

## Tutorials

### Python Example

Deploy a Python Flask application:

1. **Create Application:**

   ```python
   from flask import Flask
   app = Flask(__name__)

   @app.route('/')
   def hello():
       return 'Hello from dstack!'

   if __name__ == '__main__':
       app.run(host='0.0.0.0', port=8080)
   ```

2. **Dockerize:**

   ```dockerfile
   FROM python:3.9
   WORKDIR /app
   COPY . /app
   RUN pip install flask
   CMD ["python", "app.py"]
   ```

3. **Deploy:**

   ```bash
   dstack deploy -f docker-compose.yml
   ```

4. **Verify:** Check the web UI or access the application URL.

### JavaScript Example

Deploy a Node.js application:

1. **Create Application:**

   ```javascript
   const express = require('express');
   const app = express();

   app.get('/', (req, res) => {
     res.send('Hello from dstack!');
   });

   app.listen(8080, () => {
     console.log('Server running on port 8080');
   });
   ```

2. **Dockerize:**

   ```dockerfile
   FROM node:16
   WORKDIR /app
   COPY . /app
   RUN npm install express
   CMD ["node", "app.js"]
   ```

3. **Deploy and Verify:** Follow the same steps as above.

### Rust Example

Deploy a Rust Actix application:

1. **Create Application:**

   ```rust
   use actix_web::{web, App, HttpServer, Responder};

   async fn hello() -> impl Responder {
       "Hello from dstack!"
   }

   #[actix_web::main]
   async fn main() -> std::io::Result<()> {
       HttpServer::new(|| {
           App::new().route("/", web::get().to(hello))
       })
       .bind(("0.0.0.0", 8080))?
       .run()
       .await
   }
   ```

2. **Dockerize:**

   ```dockerfile
   FROM rust:1.65
   WORKDIR /app
   COPY . /app
   RUN cargo build --release
   CMD ["./target/release/app"]
   ```

3. **Deploy and Verify:** As above.

### Use Case: Phala Cloud

* **Goal:** Host applications securely without managing hardware.
* **Setup:** Register at [Phala Cloud](https://cloud.phala.network/register?invite=beta), deploy via web interface or API.
* **Benefits:** Pay-per-use model, minimal setup (2-3 minutes), high security.

### Use Case: Secure Web App

* **Goal:** Host a web application with sensitive data.
* **Setup:** Use the [custom-domain example](https://github.com/Dstack-TEE/dstack-examples/tree/main/custom-domain) for HTTPS with Let’s Encrypt.
* **Benefits:** Secure communication, verifiable environment, simplified certificate management.

**See Also:** [Deploying Applications](#deploying-applications), [Security Model](#security-model)

## Reference

### API Documentation

dstack provides RPC endpoints for managing deployments. Examples include:

* **CreateVm:** Creates a new CVM instance.
  * **Method:** POST
  * **Path:** `/v1/vms`
  * **Parameters:** `{ "image": "string", "config": {} }`
  * **Response:** `{ "vm_id": "string" }`

* **GetVmStatus:** Retrieves VM status.
  * **Method:** GET
  * **Path:** `/v1/vms/{vm_id}/status`
  * **Response:** `{ "status": "running" }`

**Note:** Detailed API documentation is available in the [dstack repository](https://github.com/Dstack-TEE/dstack).

### Configuration Options

* **vmm.toml:**

  ```toml
  [general]
  cid_start = 33000
  cid_pool_size = 1000
  [network]
  interface = "eth0"
  [logging]
  level = "info"
  ```

* **gateway.toml:** Configures HTTPS and routing.

* **kms.toml:** Sets up KMS parameters.

### CLI Commands

| Command | Description                 | Usage                             |
| ------- | --------------------------- | --------------------------------- |
| deploy  | Deploys an application      | `dstack deploy -f <compose-file>` |
| list    | Lists deployed applications | `dstack list`                     |
| stop    | Stops an application        | `dstack stop <app-id>`            |

**Note:** Full CLI reference is available in the [dstack repository](https://github.com/Dstack-TEE/dstack).

## Troubleshooting

### Common Errors

* **CID Conflicts:**
  * **Symptom:** Errors due to overlapping CID ranges.
  * **Solution:** Adjust `cid_start` and `cid_pool_size` in `vmm.toml`.

* **Guest Build Errors:**
  * **Symptom:** AppArmor restricts user namespaces.
  * **Solution:** Run `sudo sysctl kernel.apparmor_restrict_unprivileged_userns=0`.

* **Application Not Starting:**
  * **Symptom:** Application fails to start.
  * **Solution:** Check logs via web UI or API.

### Debugging Tips

* Monitor logs via the web UI or API.
* Verify network configurations in `docker-compose.yml`.
* Ensure sufficient system resources for CVMs.

**See Also:** [Monitoring and Logging](#monitoring-and-logging)

## Community

### Contributing to dstack

* Fork the [dstack repository](https://github.com/Dstack-TEE/dstack).
* Create a branch for your changes.
* Submit a pull request following the contribution guidelines.

### Getting Support

* Open issues on [GitHub](https://github.com/Dstack-TEE/dstack/issues).
* Refer to the [DeepWiki](https://deepwiki.com/Dstack-TEE/dstack) for detailed guides.
* Join community forums or chat channels (if available).

### FAQs

* **Q: What hardware is required for dstack?**
  * A: A TEE-capable server, such as Intel TDX, with 16GB RAM and 100GB disk space.
* **Q: Can I test dstack without TEE hardware?**
  * A: Use [Phala Cloud](https://cloud.phala.network/register?invite=beta) for testing.

**See Also:** [Getting Started](#getting-started)
